import*as storage from"./storage.js";const STORAGE_KEY_GUIDE_VIEWS="analytics-guide-views",STORAGE_KEY_SEARCH_TERMS="analytics-search-terms",STORAGE_KEY_ACHIEVEMENTS="analytics-achievements",STORAGE_KEY_SESSIONS="analytics-sessions",STORAGE_KEY_DAILY_USAGE="analytics-daily-usage",STORAGE_KEY_PAGE_LOAD="analytics-page-load";let sessionStartTime=0,sessionVisibleTime=0,lastVisibilityTime=0,isSessionActive=!0;export function init(){sessionStartTime=performance.now(),lastVisibilityTime=sessionStartTime,trackPageLoadTime(),recordDailyActive(),document.addEventListener("visibilitychange",handleVisibilityChange),setupGuideViewTracking(),setupSearchTracking()}function trackPageLoadTime(){if(window.performance&&window.performance.timing){const e=window.performance.timing,t=e.loadEventEnd-e.navigationStart;if(t>0&&t<3e4){const e=storage.get("analytics-page-load",[]);e.push({timestamp:(new Date).toISOString(),loadTime:Math.round(t)}),e.length>100&&e.shift(),storage.set("analytics-page-load",e)}}}function handleVisibilityChange(){const e=performance.now(),t=e-lastVisibilityTime;document.hidden?isSessionActive&&(sessionVisibleTime+=t,isSessionActive=!1):isSessionActive=!0,lastVisibilityTime=e}function recordDailyActive(){const e=(new Date).toISOString().split("T")[0],t=storage.get("analytics-daily-usage",[]);t.includes(e)||(t.push(e),t.length>365&&t.shift(),storage.set("analytics-daily-usage",t))}function setupGuideViewTracking(){document.addEventListener("click",e=>{const t=e.target.closest(".card[data-guide]");t&&trackGuideView(t.getAttribute("data-guide"))}),document.addEventListener("keydown",e=>{if(("Enter"===e.key||" "===e.key)&&e.target.classList.contains("card")){const t=e.target.getAttribute("data-guide");t&&trackGuideView(t)}})}function trackGuideView(e){if(!e)return;const t=storage.get("analytics-guide-views",{});t[e]||(t[e]={count:0,firstViewed:(new Date).toISOString(),lastViewed:null}),t[e].count+=1,t[e].lastViewed=(new Date).toISOString(),storage.set("analytics-guide-views",t)}function setupSearchTracking(){const e=document.getElementById("search");e&&e.addEventListener("input",e=>{const t=e.target.value.trim();t.length>=2&&trackSearchTerm(t)})}function trackSearchTerm(e){if(!e||e.length<2)return;const t=storage.get("analytics-search-terms",[]),s=t.findIndex(t=>t.term.toLowerCase()===e.toLowerCase());s>=0?(t[s].count+=1,t[s].lastSearched=(new Date).toISOString()):t.push({term:e,count:1,firstSearched:(new Date).toISOString(),lastSearched:(new Date).toISOString()}),t.length>100&&(t.sort((e,t)=>t.count-e.count),t.splice(100)),storage.set("analytics-search-terms",t)}export function trackAchievementUnlock(e,t=null){if(!e)return;const s=storage.get("analytics-achievements",{});s[e]||(s[e]={unlockedAt:t||(new Date).toISOString()},storage.set("analytics-achievements",s))}export function recordSessionEnd(){const e=performance.now();if(isSessionActive&&(sessionVisibleTime+=e-lastVisibilityTime),sessionVisibleTime>=5e3){const t=storage.get("analytics-sessions",[]);t.push({timestamp:(new Date).toISOString(),duration:Math.round(sessionVisibleTime),totalTime:Math.round(e-sessionStartTime)}),t.length>1e3&&t.shift(),storage.set("analytics-sessions",t)}}export function trackEvent(e,t,s=null){console.debug(`[Analytics] ${e}/${t}${s?"/"+s:""}`)}export function getAnalytics(){return{guideViews:storage.get("analytics-guide-views",{}),searchTerms:storage.get("analytics-search-terms",[]),achievements:storage.get("analytics-achievements",{}),sessions:storage.get("analytics-sessions",[]),dailyUsage:storage.get("analytics-daily-usage",[]),pageLoadTimes:storage.get("analytics-page-load",[])}}export function getGuideStats(){const e=storage.get("analytics-guide-views",{});return Object.entries(e).map(([e,t])=>({guideId:e,...t})).sort((e,t)=>t.count-e.count)}export function getTopSearchTerms(e=20){return storage.get("analytics-search-terms",[]).sort((e,t)=>t.count-e.count).slice(0,e)}export function getSessionStats(){const e=storage.get("analytics-sessions",[]);if(0===e.length)return{totalSessions:0,totalSessionTime:0,averageSessionTime:0,longestSession:0,shortestSession:0};const t=e.reduce((e,t)=>e+t.duration,0),s=e.map(e=>e.duration);return{totalSessions:e.length,totalSessionTime:t,averageSessionTime:Math.round(t/e.length),longestSession:Math.max(...s),shortestSession:Math.min(...s)}}export function getLoadStats(){const e=storage.get("analytics-page-load",[]);if(0===e.length)return{averageLoadTime:0,fastestLoad:0,slowestLoad:0,totalMeasurements:0};const t=e.map(e=>e.loadTime);return{averageLoadTime:Math.round(t.reduce((e,t)=>e+t,0)/t.length),fastestLoad:Math.min(...t),slowestLoad:Math.max(...t),totalMeasurements:t.length}}export function getDailyUsageStats(){const e=storage.get("analytics-daily-usage",[]),t=e.slice(-30);return{activeDaysTotal:e.length,activeDaysLast30:t.length,lastActiveDate:e.length>0?e[e.length-1]:null,firstActiveDate:e.length>0?e[0]:null,dates:e}}export function clearAnalytics(){storage.remove("analytics-guide-views"),storage.remove("analytics-search-terms"),storage.remove("analytics-achievements"),storage.remove("analytics-sessions"),storage.remove("analytics-daily-usage"),storage.remove("analytics-page-load")}export function exportAnalyticsJSON(){const e=getAnalytics();return JSON.stringify(e,null,2)}export function getStorageSize(){const e=getAnalytics();return JSON.stringify(e).length+200}window.addEventListener("beforeunload",recordSessionEnd);