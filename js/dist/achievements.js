import*as storage from"./storage.js";const achievementDefs={"first-read":{name:"First Steps",icon:"ðŸŽ“",desc:"Read your first guide",category:"milestone"},student:{name:"Student",icon:"ðŸ“š",desc:"Read 10 guides",category:"milestone"},"student-25":{name:"Eager Learner",icon:"ðŸ“–",desc:"Read 25 guides",category:"milestone"},"student-75":{name:"Knowledge Seeker",icon:"ðŸ“•",desc:"Read 75 guides",category:"milestone"},"student-150":{name:"Wisdom Collector",icon:"ðŸ“š",desc:"Read 150 guides",category:"milestone"},scholar:{name:"Scholar",icon:"ðŸŽ“",desc:"Read 50 guides",category:"milestone"},master:{name:"Master",icon:"ðŸ‘¨â€ðŸ«",desc:"Read 100 guides",category:"milestone"},completionist:{name:"Completionist",icon:"ðŸ†",desc:"Read all guides",category:"milestone"},survivor:{name:"Survivor",icon:"ðŸ’ª",desc:"Complete all Critical guides",category:"category"},rebuilder:{name:"Rebuilder",icon:"ðŸ—ï¸",desc:"Complete all Rebuild Civilization guides",category:"category"},medic:{name:"Field Medic",icon:"âš•ï¸",desc:"Complete all medical guides",category:"category"},smith:{name:"Blacksmith",icon:"âš’ï¸",desc:"Complete all crafts & manufacturing guides",category:"category"},engineer:{name:"Engineer",icon:"âš™ï¸",desc:"Complete all building & engineering guides",category:"category"},farmer:{name:"Farmer",icon:"ðŸŒ¾",desc:"Complete all agriculture & food guides",category:"category"},"comms-expert":{name:"Communications Expert",icon:"ðŸ“¡",desc:"Complete all communications guides",category:"category"},scientist:{name:"Scientist",icon:"ðŸ”¬",desc:"Complete all science guides",category:"category"},defender:{name:"Defender",icon:"ðŸ›¡ï¸",desc:"Complete all security & defense guides",category:"category"},explorer:{name:"Explorer",icon:"ðŸ—ºï¸",desc:"Read from 5 different categories",category:"special"},"early-bird":{name:"Early Bird",icon:"ðŸŒ…",desc:"Read 3 guides in one day",category:"special"},dedicated:{name:"Dedicated",icon:"ðŸ”¥",desc:"Read guides for 7 consecutive days",category:"special"},"week-warrior":{name:"Week Warrior",icon:"âš¡",desc:"Read guides for 14 consecutive days",category:"special"},"month-master":{name:"Month Master",icon:"ðŸ’«",desc:"Read guides for 30 consecutive days",category:"special"},"note-taker":{name:"Scribe",icon:"ðŸ“",desc:"Write notes on 10 guides",category:"content"},journalist:{name:"Journalist",icon:"ðŸ“„",desc:"Write notes on 25 guides",category:"content"}};export function trackReadingSession(e){const t=(new Date).toDateString(),n=storage.get("achievement-reading-dates",{});n[t]||(n[t]=[]),n[t].includes(e)||(n[t].push(e),storage.set("achievement-reading-dates",n),checkDailyAchievements(n))}function checkDailyAchievements(e){const t=storage.getAchievements(),n={};Object.assign(n,t);const s=(new Date).toDateString();var a;(e[s]?e[s].length:0)>=3&&!n[a="early-bird"]&&achievementDefs[a]&&(n[a]={unlockedAt:Date.now()},showAchievementToast(a,achievementDefs[a]),storage.setAchievements(n)),updateStreakAchievements(e)}function updateStreakAchievements(e){const t=storage.getAchievements(),n={};function s(e){!n[e]&&achievementDefs[e]&&(n[e]={unlockedAt:Date.now()},showAchievementToast(e,achievementDefs[e]),storage.setAchievements(n))}Object.assign(n,t);const a=calculateCurrentStreak(e);storage.set("current-reading-streak",a),a>=7&&s("dedicated"),a>=14&&s("week-warrior"),a>=30&&s("month-master")}function calculateCurrentStreak(e){const t=Object.keys(e).map(e=>new Date(e)).sort((e,t)=>t-e);if(0===t.length)return 0;let n=0,s=new Date;s.setHours(0,0,0,0);const a=new Date(t[0]);a.setHours(0,0,0,0);const c=Math.floor((s-a)/864e5);if(c>1)return 0;const o=c;for(let e of t){const t=new Date(e);t.setHours(0,0,0,0);const a=Math.floor((s-t)/864e5);if(a===n+o)n++;else if(a>n+o)break}return n}export function getCurrentStreak(){return storage.get("current-reading-streak",0)}export function checkAchievements(e){const t=storage.getAchievements(),n={};Object.assign(n,t);const s=storage.getProgress();let a=0,c=0,o=0,r=0,i=0,d=0,l=0,u=0,m=0,g=0,h=0,v=0,f=0,p=0,y=0,b=0,k=0,A=0,D=0,w=0;const C=new Set;function S(e){!n[e]&&achievementDefs[e]&&(n[e]={unlockedAt:Date.now()},showAchievementToast(e,achievementDefs[e]))}e.forEach(e=>{const t=e.getAttribute("data-guide"),n=s[t]?.completed,S=(e.getAttribute("data-tags")||"").split(" "),E=e.getAttribute("data-category")||"",x=!!storage.getNotes(t);n&&(a++,E&&C.add(E)),x&&w++,S.includes("critical")&&(o++,n&&c++),S.includes("rebuild")&&(i++,n&&r++),"medical"===E&&(l++,n&&d++),"crafts"!==E&&"metalworking"!==E||(m++,n&&u++),"building"===E&&(h++,n&&g++),"agriculture"===E&&(f++,n&&v++),"communications"===E&&(y++,n&&p++),"sciences"===E&&(k++,n&&b++),"defense"===E&&(D++,n&&A++)}),a>=1&&S("first-read"),a>=10&&S("student"),a>=25&&S("student-25"),a>=50&&S("scholar"),a>=75&&S("student-75"),a>=100&&S("master"),a>=150&&S("student-150"),a>=e.length&&S("completionist"),c===o&&o>0&&S("survivor"),r===i&&i>0&&S("rebuilder"),d===l&&l>0&&S("medic"),u===m&&m>0&&S("smith"),g===h&&h>0&&S("engineer"),v===f&&f>0&&S("farmer"),p===y&&y>0&&S("comms-expert"),b===k&&k>0&&S("scientist"),A===D&&D>0&&S("defender"),C.size>=5&&S("explorer"),w>=10&&S("note-taker"),w>=25&&S("journalist"),storage.setAchievements(n),updateAchievementButton(n)}function updateAchievementButton(e){const t=Object.keys(e).length,n=document.getElementById("achievement-count"),s=document.getElementById("achievement-total");n&&(n.textContent=t),s&&(s.textContent=Object.keys(achievementDefs).length)}function showAchievementToast(e,t){const n=document.createElement("div");n.className="achievement-toast",n.innerHTML=`<span class="icon">${t.icon}</span><span class="text"><span class="title">ðŸŽ‰ ${t.name}</span><span class="desc">${t.desc}</span></span>`,document.body.appendChild(n),setTimeout(()=>{n.classList.add("hide"),setTimeout(()=>n.remove(),300)},4e3)}export function getAchievementDefs(){return achievementDefs}export function showAchievementsModal(){const e=storage.getAchievements(),t=document.getElementById("achievements-grid");if(!t)return;t.innerHTML="",Object.entries(achievementDefs).forEach(([n,s])=>{const a=document.createElement("div");a.className="achievement-item",e[n]&&a.classList.add("unlocked");const c=getAchievementProgress(n);let o="";c&&c.current<c.target&&(o=`<div class="achievement-progress"><div class="progress-bar"><div class="progress-fill" style="width: ${c.current/c.target*100}%"></div></div><div class="progress-text">${c.current}/${c.target}</div></div>`),a.innerHTML=`<span class="icon">${s.icon}</span><div class="name">${s.name}</div><div class="desc">${s.desc}</div>${o}`,t.appendChild(a)});const n=document.getElementById("achievements-modal");if(n){n.classList.add("active"),trapFocusInModal(n);const e=n.querySelector(".achievements-close");e&&e.focus()}}function getAchievementProgress(e){const t=storage.getProgress(),n=document.querySelectorAll("[data-guide]");let s=0,a=0;switch(e){case"student":s=Object.values(t).filter(e=>e.completed).length,a=10;break;case"student-25":s=Object.values(t).filter(e=>e.completed).length,a=25;break;case"student-75":s=Object.values(t).filter(e=>e.completed).length,a=75;break;case"student-150":s=Object.values(t).filter(e=>e.completed).length,a=150;break;case"scholar":s=Object.values(t).filter(e=>e.completed).length,a=50;break;case"master":s=Object.values(t).filter(e=>e.completed).length,a=100;break;case"note-taker":s=Object.keys(t).filter(e=>!!storage.getNotes(e)).length,a=10;break;case"journalist":s=Object.keys(t).filter(e=>!!storage.getNotes(e)).length,a=25;break;case"explorer":const e=new Set;n.forEach(n=>{const s=n.getAttribute("data-category")||"",a=n.getAttribute("data-guide");t[a]?.completed&&s&&e.add(s)}),s=e.size,a=5;break;case"dedicated":s=getCurrentStreak(),a=7;break;case"week-warrior":s=getCurrentStreak(),a=14;break;case"month-master":s=getCurrentStreak(),a=30;break;default:return null}return s<a?{current:s,target:a}:null}export function closeAchievementsModal(){const e=document.getElementById("achievements-modal");if(e){e.classList.remove("active");const t=document.querySelector(".achievements-modal-trigger");t&&setTimeout(()=>t.focus(),100)}}function getFocusableElements(e){return Array.from(e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(e=>!e.hasAttribute("disabled")&&null!==e.offsetParent)}function trapFocusInModal(e){const t=getFocusableElements(e);if(0===t.length)return;const n=t[0],s=t[t.length-1];e.addEventListener("keydown",e=>{if("Escape"===e.key)return e.preventDefault(),void closeAchievementsModal();"Tab"===e.key&&(e.shiftKey?document.activeElement===n&&(e.preventDefault(),s.focus()):document.activeElement===s&&(e.preventDefault(),n.focus()))})}