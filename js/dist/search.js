import*as storage from"./storage.js";import{escapeHtml}from"./utils.js";let searchInput=null,searchResults=null,guideData=[],currentActiveIndex=-1,config={minChars:2,maxResults:8};function buildGuideData(e){guideData=[],Array.isArray(e)?guideData=e.map(e=>({title:e.title||"",desc:e.description||"",href:e.url||`guides/${e.id}.html`,tags:Array.isArray(e.tags)?e.tags.join(" "):e.tags||"",section:e.category||""})):e.forEach(e=>{guideData.push({title:e.querySelector("h3")?.textContent||"",desc:e.querySelector("p")?.textContent||"",href:e.getAttribute("href"),tags:e.getAttribute("data-tags")||"",section:e.closest("[data-section]")?.getAttribute("data-section")||""})})}function highlightText(e,t){if(!t)return escapeHtml(e);const s=escapeHtml(e),r=escapeHtml(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),c=new RegExp(`(${r})`,"gi");return s.replace(c,'<mark class="search-highlight">$1</mark>')}function getRecentSearches(){return storage.get("compendium-recent-searches",[])}function addRecentSearch(e){if(!e||e.length<config.minChars)return;let t=getRecentSearches();t=t.filter(t=>t.toLowerCase()!==e.toLowerCase()),t.unshift(e),t=t.slice(0,5),storage.set("compendium-recent-searches",t)}function showRecentSearches(){const e=getRecentSearches();if(0===e.length)return searchResults.innerHTML='<div style="padding:12px;color:var(--muted);font-size:0.85rem">No recent searches</div>',void searchResults.classList.add("active");let t='<div class="recent-searches">';t+='<div class="search-category-header">Recent Searches</div>',e.forEach(e=>{const s=escapeHtml(e);t+=`<a href="#" class="search-recent-item" data-query="${s}">${s}</a>`}),t+="</div>",searchResults.innerHTML=t,searchResults.classList.add("active"),document.querySelectorAll(".search-recent-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.getAttribute("data-query");searchInput.value=s,performSearch(s)})})}function groupByCategory(e){const t={};return e.forEach(e=>{const s=e.section||"Other";t[s]||(t[s]=[]),t[s].push(e)}),t}function renderResults(e,t){if(0===t.length)return searchResults.innerHTML='<div style="padding:12px;color:var(--muted)">No matches â€” try <a href="guides/search.html" style="color:var(--accent)">full-text search</a></div>',void searchResults.classList.add("active");const s=groupByCategory(t);let r="";Object.entries(s).forEach(([t,s])=>{r+=`<div class="search-category-header">${escapeHtml(t)}</div>`,s.forEach((t,s)=>{const c=highlightText(t.title,e),a=highlightText(t.desc,e);r+=`<a href="${escapeHtml(t.href)}" class="search-result" data-index="${s}">\n        <div class="search-result-content">\n          <div class="search-result-title">${c}</div>\n          <div class="search-result-desc">${a}</div>\n        </div>\n      </a>`})}),searchResults.innerHTML=r,searchResults.classList.add("active"),currentActiveIndex=-1,attachResultClickHandlers()}function attachResultClickHandlers(){document.querySelectorAll(".search-result").forEach(e=>{e.addEventListener("click",t=>{0===t.button&&(e.getAttribute("href"),addRecentSearch(searchInput.value))})})}function performSearch(e){const t=e.toLowerCase().trim();if(t.length<config.minChars)return void searchResults.classList.remove("active");const s=guideData.filter(e=>{const s=e.title.toLowerCase().includes(t),r=e.desc.toLowerCase().includes(t),c=e.tags.toLowerCase().includes(t);return s||r||c}).slice(0,config.maxResults);renderResults(t,s)}function handleKeyboardNavigation(e){const t=document.querySelectorAll(".search-result");if("ArrowDown"===e.key)e.preventDefault(),currentActiveIndex=Math.min(currentActiveIndex+1,t.length-1),updateActiveResult(t);else if("ArrowUp"===e.key)e.preventDefault(),currentActiveIndex=Math.max(currentActiveIndex-1,-1),updateActiveResult(t);else if("Enter"===e.key)if(e.preventDefault(),currentActiveIndex>=0&&t[currentActiveIndex]){const e=t[currentActiveIndex].getAttribute("href");addRecentSearch(searchInput.value),window.location.href=e}else searchInput.value.length>=config.minChars&&(addRecentSearch(searchInput.value),window.location.href="guides/search.html?q="+encodeURIComponent(searchInput.value));else"Escape"===e.key&&(e.preventDefault(),searchResults.classList.remove("active"))}function updateActiveResult(e){e.forEach((e,t)=>{e.classList.remove("active"),t===currentActiveIndex&&(e.classList.add("active"),e.scrollIntoView({block:"nearest"}))})}export function initializeSearch(e,t={}){searchInput=document.getElementById("search")||document.getElementById("quick-search-input"),searchResults=document.getElementById("search-results")||document.getElementById("quick-search-results"),searchInput&&searchResults&&(config={...config,...t},buildGuideData(e),searchInput.addEventListener("input",e=>{performSearch(e.target.value)}),searchInput.addEventListener("focus",e=>{const t=e.target.value.trim();0===t.length?showRecentSearches():t.length>=config.minChars&&searchResults.classList.add("active")}),searchInput.addEventListener("blur",()=>{setTimeout(()=>searchResults.classList.remove("active"),200)}),searchInput.addEventListener("keydown",handleKeyboardNavigation))}export function focusSearch(){searchInput&&searchInput.focus()}