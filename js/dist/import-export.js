import*as storage from"./storage.js";import*as collections from"./collections.js";const DB_NAME="compendium-backup",STORE_NAME="backups",METADATA_STORE="metadata";async function initializeIndexedDB(){return new Promise((e,t)=>{const o=indexedDB.open(DB_NAME,1);o.onerror=()=>t(o.error),o.onsuccess=()=>e(o.result),o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("backups")||t.createObjectStore("backups",{keyPath:"id",autoIncrement:!0}),t.objectStoreNames.contains("metadata")||t.createObjectStore("metadata",{keyPath:"key"})}})}async function saveToIndexedDB(e){try{(await initializeIndexedDB()).transaction(["backups"],"readwrite").objectStore("backups").add({data:e,timestamp:(new Date).toISOString()})}catch(e){console.warn("Failed to save backup to IndexedDB:",e)}}async function getLatestBackupFromIndexedDB(){try{const e=await initializeIndexedDB();return new Promise(t=>{const o=e.transaction(["backups"],"readonly").objectStore("backups").getAll();o.onsuccess=()=>{const e=o.result;e.length>0?t(e[e.length-1]):t(null)},o.onerror=()=>t(null)})}catch(e){return console.warn("Failed to retrieve backup from IndexedDB:",e),null}}function gatherExportData(){const e={version:"3.0",exportDate:(new Date).toISOString(),progress:storage.get("compendium-progress"),theme:storage.get("compendium-theme"),achievements:storage.get("compendium-achievements")},t=storage.getAllWithPrefix("compendium-notes-"),o={};t.forEach(e=>{const t=e.replace("compendium-notes-","");o[t]=storage.get(e)}),e.notes=o;try{e.collections=collections.exportCollections()}catch(e){console.warn("Failed to export collections:",e)}return e}function convertNotesToCSV(e){const t=[["Guide ID","Notes"]];return Object.entries(e).forEach(([e,o])=>{if(o){const n=o.replace(/"/g,'""');t.push([e,`"${n}"`])}}),t.map(e=>e.join(",")).join("\n")}function convertProgressToCSV(e){const t=[["Guide ID","Completed","Pages Read","Last Updated"]];return Object.entries(e).forEach(([e,o])=>{if(o){const n=o.completed?"Yes":"No",r=o.pagesRead||0,a=o.lastUpdated||"";t.push([e,n,r,a])}}),t.map(e=>e.join(",")).join("\n")}function convertNotesToMarkdown(e){let t="# Survival Compendium - Notes Export\n\n";return t+=`*Exported: ${(new Date).toISOString()}*\n\n`,Object.entries(e).forEach(([e,o])=>{o&&(t+=`## ${e}\n\n`,t+=`${o}\n\n`)}),t}function downloadFile(e,t,o){const n=new Blob([e],{type:o}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r,a.download=t,a.click(),URL.revokeObjectURL(r)}export function showExportModal(){const e=document.getElementById("export-format-modal");e&&e.remove();const t=document.createElement("div");t.id="export-format-modal",t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-labelledby","export-modal-title"),t.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.5);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10000;\n  ";const o=document.createElement("div");o.style.cssText="\n    background: var(--bg, #1a1a1a);\n    border: 2px solid var(--accent, #d4a574);\n    border-radius: 12px;\n    padding: 32px;\n    max-width: 500px;\n    color: var(--text, #f5f0e8);\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n  ",o.innerHTML='\n    <h2 id="export-modal-title" style="margin-top: 0; color: var(--accent, #d4a574);">Choose Export Format</h2>\n    <p style="margin-bottom: 24px;">Select how you\'d like to export your data:</p>\n    <div style="display: flex; flex-direction: column; gap: 12px;">\n      <button onclick="exportAsJSON()" style="\n        padding: 12px 16px;\n        background: rgba(212, 165, 116, 0.2);\n        border: 1px solid var(--accent, #d4a574);\n        border-radius: 8px;\n        color: var(--text, #f5f0e8);\n        cursor: pointer;\n        text-align: left;\n        transition: all 0.2s;\n      " onmouseover="this.style.background=\'rgba(212, 165, 116, 0.3)\'" onmouseout="this.style.background=\'rgba(212, 165, 116, 0.2)\'">\n        <strong>üìã Export as JSON</strong><br>\n        <small>Complete backup with all data and settings</small>\n      </button>\n      <button onclick="exportNotesAsCSV()" style="\n        padding: 12px 16px;\n        background: rgba(212, 165, 116, 0.2);\n        border: 1px solid var(--accent, #d4a574);\n        border-radius: 8px;\n        color: var(--text, #f5f0e8);\n        cursor: pointer;\n        text-align: left;\n        transition: all 0.2s;\n      " onmouseover="this.style.background=\'rgba(212, 165, 116, 0.3)\'" onmouseout="this.style.background=\'rgba(212, 165, 116, 0.2)\'">\n        <strong>üìä Export Notes as CSV</strong><br>\n        <small>Your notes in spreadsheet format</small>\n      </button>\n      <button onclick="exportProgressAsCSV()" style="\n        padding: 12px 16px;\n        background: rgba(212, 165, 116, 0.2);\n        border: 1px solid var(--accent, #d4a574);\n        border-radius: 8px;\n        color: var(--text, #f5f0e8);\n        cursor: pointer;\n        text-align: left;\n        transition: all 0.2s;\n      " onmouseover="this.style.background=\'rgba(212, 165, 116, 0.3)\'" onmouseout="this.style.background=\'rgba(212, 165, 116, 0.2)\'">\n        <strong>üìà Export Progress as CSV</strong><br>\n        <small>Your reading progress and bookmarks</small>\n      </button>\n      <button onclick="exportNotesAsMarkdown()" style="\n        padding: 12px 16px;\n        background: rgba(212, 165, 116, 0.2);\n        border: 1px solid var(--accent, #d4a574);\n        border-radius: 8px;\n        color: var(--text, #f5f0e8);\n        cursor: pointer;\n        text-align: left;\n        transition: all 0.2s;\n      " onmouseover="this.style.background=\'rgba(212, 165, 116, 0.3)\'" onmouseout="this.style.background=\'rgba(212, 165, 116, 0.2)\'">\n        <strong>üìù Export Notes as Markdown</strong><br>\n        <small>Your notes as a markdown document</small>\n      </button>\n    </div>\n    <button onclick="closeExportModal()" style="\n      margin-top: 24px;\n      padding: 10px 20px;\n      background: rgba(212, 165, 116, 0.1);\n      border: 1px solid rgba(212, 165, 116, 0.3);\n      border-radius: 6px;\n      color: var(--text, #f5f0e8);\n      cursor: pointer;\n      width: 100%;\n    ">Cancel</button>\n  ',t.appendChild(o),document.body.appendChild(t),t.addEventListener("click",e=>{e.target===t&&closeExportModal()})}export function closeExportModal(){const e=document.getElementById("export-format-modal");e&&e.remove()}export function exportAsJSON(){closeExportModal();const e=gatherExportData(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download="compendium-backup-"+Date.now()+".json",n.click(),URL.revokeObjectURL(o),updateLastExportDate(),saveToIndexedDB(e)}export function exportProgress(){showExportModal()}export function exportNotesAsCSV(){closeExportModal(),downloadFile(convertNotesToCSV(storage.getAllNotes()),"compendium-notes-"+Date.now()+".csv","text/csv"),updateLastExportDate(),saveToIndexedDB(gatherExportData())}export function exportProgressAsCSV(){closeExportModal(),downloadFile(convertProgressToCSV(storage.get("compendium-progress",{})),"compendium-progress-"+Date.now()+".csv","text/csv"),updateLastExportDate(),saveToIndexedDB(gatherExportData())}export function exportNotesAsMarkdown(){closeExportModal(),downloadFile(convertNotesToMarkdown(storage.getAllNotes()),"compendium-notes-"+Date.now()+".md","text/markdown"),updateLastExportDate(),saveToIndexedDB(gatherExportData())}function updateLastExportDate(){const e=(new Date).toISOString();storage.set("compendium-last-export-date",e)}export function checkBackupReminder(){const e=storage.get("compendium-last-export-date");if(!e)return void showBackupReminder(!0);const t=new Date(e),o=new Date,n=Math.floor((o-t)/864e5);n>30&&showBackupReminder(!1,n)}function showBackupReminder(e=!1,t=0){if(document.getElementById("backup-reminder-banner"))return;const o=document.createElement("div");o.id="backup-reminder-banner",o.setAttribute("role","alert"),o.setAttribute("aria-live","assertive"),o.style.cssText="\n    background: linear-gradient(135deg, rgba(212, 165, 116, 0.2) 0%, rgba(212, 165, 116, 0.1) 100%);\n    border-left: 4px solid var(--accent, #d4a574);\n    padding: 16px 20px;\n    margin: 12px 20px;\n    border-radius: 6px;\n    display: flex;\n    align-items: center;\n    gap: 16px;\n    color: var(--text, #f5f0e8);\n    max-width: calc(100% - 40px);\n  ";const n=e?"‚ö†Ô∏è Your reading progress has never been backed up. Consider exporting your data regularly!":`‚ö†Ô∏è Your last backup was ${t} days ago. Time to back up your progress!`;o.innerHTML=`\n    <span style="flex: 1;">${n}</span>\n    <button onclick="showExportModal()" style="\n      padding: 8px 16px;\n      background: var(--accent, #d4a574);\n      color: #000;\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n      font-weight: bold;\n      white-space: nowrap;\n      transition: opacity 0.2s;\n    " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">\n      Backup Now\n    </button>\n    <button onclick="this.parentElement.remove()" style="\n      padding: 6px 10px;\n      background: transparent;\n      border: 1px solid rgba(212, 165, 116, 0.3);\n      border-radius: 4px;\n      color: var(--text, #f5f0e8);\n      cursor: pointer;\n      transition: all 0.2s;\n    " onmouseover="this.style.background='rgba(212, 165, 116, 0.1)'" onmouseout="this.style.background='transparent'">\n      Dismiss\n    </button>\n  `;const r=document.querySelector(".tools-bar")||document.querySelector(".container");r&&r.insertAdjacentElement("beforebegin",o)}export function importProgress(){const e=document.getElementById("import-file");e&&e.click()}export async function checkAndOfferIndexedDBRestore(){const e=storage.get("compendium-progress");if(e&&Object.keys(e).length>0)return;const t=await getLatestBackupFromIndexedDB();t&&showRestoreModal(t)}function showRestoreModal(e){const t=document.createElement("div");t.id="restore-modal",t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-labelledby","restore-modal-title"),t.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.6);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10000;\n  ";const o=document.createElement("div");o.style.cssText="\n    background: var(--bg, #1a1a1a);\n    border: 2px solid var(--accent, #d4a574);\n    border-radius: 12px;\n    padding: 32px;\n    max-width: 500px;\n    color: var(--text, #f5f0e8);\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n  ";const n=new Date(e.data.exportDate).toLocaleDateString();o.innerHTML=`\n    <h2 id="restore-modal-title" style="margin-top: 0; color: var(--accent, #d4a574);">Restore from Backup?</h2>\n    <p>We found a backup from <strong>${n}</strong> in your browser's local storage. Your data appears to have been cleared.</p>\n    <p>Would you like to restore your reading progress and notes from this backup?</p>\n    <div style="display: flex; gap: 12px; margin-top: 24px;">\n      <button onclick="restoreFromIndexedDB()" style="\n        flex: 1;\n        padding: 12px 16px;\n        background: var(--accent, #d4a574);\n        color: #000;\n        border: none;\n        border-radius: 6px;\n        cursor: pointer;\n        font-weight: bold;\n        transition: opacity 0.2s;\n      " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">\n        Restore\n      </button>\n      <button onclick="closeRestoreModal()" style="\n        flex: 1;\n        padding: 12px 16px;\n        background: rgba(212, 165, 116, 0.2);\n        border: 1px solid var(--accent, #d4a574);\n        border-radius: 6px;\n        color: var(--text, #f5f0e8);\n        cursor: pointer;\n        transition: all 0.2s;\n      " onmouseover="this.style.background='rgba(212, 165, 116, 0.3)'" onmouseout="this.style.background='rgba(212, 165, 116, 0.2)'">\n        Skip\n      </button>\n    </div>\n  `,t.appendChild(o),document.body.appendChild(t),window._indexedDBBackup=e}export function closeRestoreModal(){const e=document.getElementById("restore-modal");e&&e.remove(),window._indexedDBBackup=null}export function restoreFromIndexedDB(){if(!window._indexedDBBackup)return void alert("No backup available");const e=window._indexedDBBackup.data;if(e.progress&&storage.set("compendium-progress",e.progress),e.theme&&storage.set("compendium-theme",e.theme),e.achievements&&storage.set("compendium-achievements",e.achievements),e.notes&&Object.entries(e.notes).forEach(([e,t])=>{t&&storage.set(`compendium-notes-${e}`,t)}),e.collections)try{collections.importCollections(e.collections)}catch(e){console.warn("Failed to restore collections:",e)}closeRestoreModal(),alert("Data restored successfully! Refreshing..."),location.reload()}export function initializeImportHandler(){const e=document.getElementById("import-file");e&&e.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=e=>{try{const t=JSON.parse(e.target.result);if(!validateImportData(t))return void alert("Invalid backup file format");if(t.progress&&storage.set("compendium-progress",t.progress),t.theme&&storage.set("compendium-theme",t.theme),t.achievements&&storage.set("compendium-achievements",t.achievements),t.notes&&Object.entries(t.notes).forEach(([e,t])=>{t&&storage.set(`compendium-notes-${e}`,t)}),Object.keys(t).forEach(e=>{e.startsWith("compendium-notes-")&&storage.set(e,t[e])}),t.collections)try{collections.importCollections(t.collections)}catch(e){console.warn("Failed to import collections:",e)}location.reload()}catch(e){alert("Invalid backup file")}},o.readAsText(t)})}function validateImportData(e){return"object"==typeof e&&null!==e&&("version"in e||"progress"in e||"theme"in e)}export function resetProgress(){confirm("Reset all reading progress and notes? This cannot be undone.")&&(storage.clearPrefix("compendium-"),location.reload())}export async function autoBackupProgress(){try{const e=gatherExportData();await saveToIndexedDB(e)}catch(e){console.warn("Auto-backup failed:",e)}}