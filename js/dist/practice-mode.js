import*as storage from"./storage.js";const PRACTICE_KEY="compendium-practice",PRACTICE_NOTES_KEY="compendium-practice-notes";export function init(){document.addEventListener("cardsRendered",attachPracticeListeners),document.addEventListener("cardsRerendered",attachPracticeListeners),document.querySelectorAll(".card[data-guide]").length>0&&attachPracticeListeners()}function getPracticeData(){return storage.get(PRACTICE_KEY,{})}function savePracticeData(t){storage.set(PRACTICE_KEY,t)}export function markPracticed(t,e=""){const c=getPracticeData();return c[t]||(c[t]={}),c[t].practiced=!0,c[t].practiceDate=(new Date).toISOString(),e&&(c[t].notes=e),savePracticeData(c),updatePracticeUI(t),c[t]}export function unmarkPracticed(t){const e=getPracticeData();e[t]&&(e[t].practiced=!1,delete e[t].practiceDate,delete e[t].notes),savePracticeData(e),updatePracticeUI(t)}export function getPracticeStatus(t){return getPracticeData()[t]||null}export function getAllPracticed(){const t=getPracticeData(),e={};for(const[c,a]of Object.entries(t))a.practiced&&(e[c]=a);return e}export function getPracticeCount(){return Object.keys(getAllPracticed()).length}export function getPracticeNotes(t){const e=getPracticeStatus(t);return e?.notes||null}export function setPracticeNotes(t,e){const c=getPracticeData();c[t]||(c[t]={practiced:!1}),c[t].notes=storage.sanitize(e),savePracticeData(c)}export function clearAllPractice(){storage.set(PRACTICE_KEY,{}),document.querySelectorAll(".card[data-guide]").forEach(t=>{updatePracticeUI(t.getAttribute("data-guide"))})}function attachPracticeListeners(){document.querySelectorAll(".card[data-guide]").forEach(t=>{const e=t.getAttribute("data-guide");let c=t.querySelector(".practice-btn");c||(c=createPracticeButton(e),t.appendChild(c)),c.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),togglePracticeStatus(e)}),updatePracticeUI(e)})}function createPracticeButton(t){const e=document.createElement("button");e.className="practice-btn",e.setAttribute("aria-label","Mark as practiced"),e.setAttribute("title","I've practiced this skill"),e.setAttribute("type","button");const c=document.createElement("span");return c.className="practice-icon",c.setAttribute("aria-hidden","true"),e.appendChild(c),e}function updatePracticeUI(t){const e=document.querySelector(`[data-guide="${t}"]`);if(!e)return;const c=e.querySelector(".practice-btn");if(!c)return;const a=getPracticeStatus(t);if(!0===a?.practiced){c.classList.add("practiced"),c.setAttribute("aria-label","Mark as not practiced");const t=c.querySelector(".practice-icon");if(t){const e=formatDate(a.practiceDate?new Date(a.practiceDate):new Date);t.textContent="âœ‹",c.setAttribute("title",`Practiced on ${e}`)}}else{c.classList.remove("practiced"),c.setAttribute("aria-label","Mark as practiced");const t=c.querySelector(".practice-icon");t&&(t.textContent="ðŸ”¨",c.setAttribute("title","I've practiced this skill"))}}function togglePracticeStatus(t){const e=getPracticeStatus(t);!0===e?.practiced?unmarkPracticed(t):markPracticed(t)}function formatDate(t){const e=new Date,c=new Date(e);return c.setDate(c.getDate()-1),t.toDateString()===e.toDateString()?"today":t.toDateString()===c.toDateString()?"yesterday":t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==e.getFullYear()?"numeric":void 0})}export function filterByPracticeStatus(t,e){t.forEach(t=>{const c=getPracticeStatus(t.getAttribute("data-guide")),a=!0===c?.practiced;let r=!0;"practiced"===e?r=a:"unpracticed"===e&&(r=!a),t.style.display=r?"":"none"})}export function getPracticeStats(){const t=document.querySelectorAll(".card[data-guide]"),e=getAllPracticed();return{totalGuides:t.length,totalPracticed:Object.keys(e).length,percentagePracticed:t.length>0?Math.round(Object.keys(e).length/t.length*100):0,recentPractice:getRecentPractice(e,7),thisWeekPractice:getWeekPractice(e)}}function getRecentPractice(t,e=7){const c=new Date;return c.setDate(c.getDate()-e),Object.entries(t).filter(([t,e])=>!!e.practiceDate&&new Date(e.practiceDate)>=c).map(([t,e])=>t)}function getWeekPractice(t){const e=new Date,c=new Date(e),a=e.getDay(),r=e.getDate()-a+(0===a?-6:1);return c.setDate(r),c.setHours(0,0,0,0),Object.entries(t).filter(([t,e])=>!!e.practiceDate&&new Date(e.practiceDate)>=c).map(([t,e])=>t)}