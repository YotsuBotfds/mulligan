import*as offlineManager from"./offline-manager.js";let isModalOpen=!1,currentProgress={};export function initUI(){createModalHTML(),attachEventListeners(),setupProgressListener()}function createModalHTML(){if(document.getElementById("offline-manager-modal"))return;const e=document.createElement("div");e.id="offline-manager-modal",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby","offline-manager-title"),e.setAttribute("aria-hidden","true"),e.innerHTML='\n    <div class="offline-manager-overlay" onclick="if(event.target === this) offlineManagerUI.closeModal()"></div>\n    <div class="offline-manager-content">\n      <div class="offline-manager-header">\n        <h2 id="offline-manager-title">üì• Manage Offline Downloads</h2>\n        <button class="offline-manager-close" onclick="offlineManagerUI.closeModal()" aria-label="Close offline manager">√ó</button>\n      </div>\n\n      <div class="offline-manager-body">\n        <div class="offline-info-bar">\n          <div class="offline-info-item">\n            <span class="offline-info-label">Total Storage Used:</span>\n            <span class="offline-info-value" id="total-storage">0 KB</span>\n          </div>\n          <div class="offline-info-item">\n            <span class="offline-info-label">Categories Cached:</span>\n            <span class="offline-info-value" id="categories-cached">0</span>\n          </div>\n        </div>\n\n        <div class="offline-manager-tabs">\n          <button class="offline-tab-btn active" data-tab="categories">Categories</button>\n          <button class="offline-tab-btn" data-tab="help">Help</button>\n        </div>\n\n        <div id="categories-tab" class="offline-tab-content active">\n          <div class="offline-actions">\n            <button class="offline-action-btn cache-all-btn" id="cache-all-btn" onclick="offlineManagerUI.cacheAll()">\n              üíæ Cache All\n            </button>\n            <button class="offline-action-btn clear-all-btn" id="clear-all-btn" onclick="offlineManagerUI.clearAll()">\n              üóëÔ∏è Clear All\n            </button>\n          </div>\n\n          <div class="offline-categories-list" id="categories-list">\n            \x3c!-- Categories will be populated here --\x3e\n          </div>\n        </div>\n\n        <div id="help-tab" class="offline-tab-content">\n          <div class="offline-help-content">\n            <h3>How to Use Offline Mode</h3>\n            <ul>\n              <li><strong>Select Categories:</strong> Toggle the switch next to each category to download it for offline use</li>\n              <li><strong>Monitor Progress:</strong> Watch the progress bar while guides are being cached</li>\n              <li><strong>View Badges:</strong> Cached guides will show an "Available Offline" badge</li>\n              <li><strong>Storage Size:</strong> Total storage shows how much space is used</li>\n              <li><strong>Quick Actions:</strong> Use "Cache All" to download everything, or "Clear All" to remove all offline guides</li>\n            </ul>\n            <p><strong>Note:</strong> Offline guides are stored in your browser\'s cache. Clearing browser data will remove them.</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  ',document.body.appendChild(e),populateCategories()}async function populateCategories(){const e=document.getElementById("categories-list");if(!e)return;const t=offlineManager.getCategoryList();0!==t.length?(e.innerHTML=t.map(e=>createCategoryItemHTML(e)).join(""),document.querySelectorAll(".offline-toggle").forEach(e=>{e.addEventListener("change",handleToggleChange)})):e.innerHTML='<div class="offline-empty">No categories available</div>'}function createCategoryItemHTML(e){const t=offlineManager.formatBytes(e.estimatedSize);return offlineManager.formatBytes(e.cachedSize),`\n    <div class="offline-category-item" data-category="${e.id}">\n      <div class="offline-category-header">\n        <div class="offline-category-info">\n          <h4 class="offline-category-name">${e.name}</h4>\n          <p class="offline-category-meta">\n            ${e.guideCount} guide${1!==e.guideCount?"s":""} ‚Ä¢ ${t}\n          </p>\n        </div>\n        <div class="offline-category-controls">\n          <label class="offline-toggle-switch">\n            <input\n              type="checkbox"\n              class="offline-toggle"\n              data-category="${e.id}"\n              ${e.isCached?"checked":""}\n              aria-label="Toggle offline cache for ${e.name}"\n            />\n            <span class="offline-toggle-slider"></span>\n          </label>\n        </div>\n      </div>\n\n      <div class="offline-category-progress" data-category="${e.id}" style="display: none;">\n        <div class="offline-progress-bar">\n          <div class="offline-progress-fill" style="width: 0%"></div>\n        </div>\n        <p class="offline-progress-text">Downloading... <span class="offline-progress-percent">0%</span></p>\n      </div>\n\n      <div class="offline-category-cached" data-category="${e.id}" ${e.isCached?"":'style="display: none;"'}>\n        <p class="offline-cached-text">\n          ‚úì Cached: ${offlineManager.formatBytes(e.cachedSize)} (${e.cachedCount} items)\n        </p>\n      </div>\n    </div>\n  `}async function handleToggleChange(e){const t=e.target,n=t.dataset.category,a=t.checked;t.closest(".offline-category-item"),a?(showProgress(n),t.disabled=!0,await offlineManager.cacheCategory(n),t.disabled=!1,hideProgress(n),updateCachedIndicator(n,!0),updateTotalStorage()):(await offlineManager.uncacheCategory(n),updateCachedIndicator(n,!1),updateTotalStorage())}function showProgress(e){const t=document.querySelector(`.offline-category-progress[data-category="${e}"]`);t&&(t.style.display="block")}function hideProgress(e){const t=document.querySelector(`.offline-category-progress[data-category="${e}"]`);t&&(t.style.display="none")}function updateCachedIndicator(e,t){const n=document.querySelector(`.offline-category-cached[data-category="${e}"]`);if(n)if(t){n.style.display="block";const t=offlineManager.getCategoryList().find(t=>t.id===e);t&&(n.innerHTML=`\n          <p class="offline-cached-text">\n            ‚úì Cached: ${offlineManager.formatBytes(t.cachedSize)} (${t.cachedCount} items)\n          </p>\n        `)}else n.style.display="none"}export function updateTotalStorage(){const e=offlineManager.getTotalStorageUsed(),t=document.getElementById("total-storage");t&&(t.textContent=offlineManager.formatBytes(e));const n=offlineManager.getCategoryList().filter(e=>e.isCached).length,a=document.getElementById("categories-cached");a&&(a.textContent=n)}function setupProgressListener(){document.addEventListener("offline-manager:progress",e=>{const{category:t,current:n,total:a,percentage:o}=e.detail,l=document.querySelector(`.offline-category-progress[data-category="${t}"] .offline-progress-fill`),i=document.querySelector(`.offline-category-progress[data-category="${t}"] .offline-progress-percent`);l&&(l.style.width=o+"%"),i&&(i.textContent=o+"%")})}function attachEventListeners(){document.querySelectorAll(".offline-tab-btn").forEach(e=>{e.addEventListener("click",e=>{switchTab(e.target.dataset.tab)})}),document.addEventListener("keydown",e=>{"Escape"===e.key&&isModalOpen&&closeModal()})}function switchTab(e){document.querySelectorAll(".offline-tab-btn").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".offline-tab-content").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.getElementById(`${e}-tab`).classList.add("active")}export function openModal(){const e=document.getElementById("offline-manager-modal");e&&(e.setAttribute("aria-hidden","false"),e.classList.add("active"),isModalOpen=!0,document.body.style.overflow="hidden",updateTotalStorage(),populateCategories())}export function closeModal(){const e=document.getElementById("offline-manager-modal");e&&(e.setAttribute("aria-hidden","true"),e.classList.remove("active"),isModalOpen=!1,document.body.style.overflow="auto")}export async function cacheAll(){const e=document.getElementById("cache-all-btn");e&&(e.disabled=!0);const t=document.querySelectorAll(".offline-toggle:not(:checked)");for(const e of t)e.click(),await new Promise(e=>setTimeout(e,100));e&&(e.disabled=!1)}export async function clearAll(){if(!confirm("Are you sure you want to clear all offline downloads? This cannot be undone."))return;const e=document.getElementById("clear-all-btn");e&&(e.disabled=!0);const t=document.querySelectorAll(".offline-toggle:checked");for(const e of t)e.click(),await new Promise(e=>setTimeout(e,100));e&&(e.disabled=!1)}export async function updateGuideOfflineBadges(){try{const e=await offlineManager.getCachedGuides();document.querySelectorAll(".card[data-guide]").forEach(t=>{const n=t.dataset.guide;if(e[n]){const e=t.querySelector(".offline-badge");e&&e.remove();const n=document.createElement("div");n.className="offline-badge",n.setAttribute("title","This guide is available offline"),n.innerHTML="üì°",t.appendChild(n)}else{const e=t.querySelector(".offline-badge");e&&e.remove()}})}catch(e){console.error("Failed to update offline badges:",e)}}