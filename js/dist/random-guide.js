import*as storage from"./storage.js";import*as cards from"./cards.js";import{escapeHtml}from"./utils.js";let allGuidesData=[];async function fetchGuidesData(){try{const e=await fetch("data/guides.json");if(!e.ok)throw new Error(`Failed to fetch guides: ${e.status}`);return await e.json()}catch(e){throw console.error("Error fetching guides.json:",e),e}}export function getRandomGuide(e={}){if(0===allGuidesData.length)return console.warn("No guides data available"),null;const t=storage.getProgress();let d=allGuidesData;if(e.category&&(d=d.filter(t=>t.category===e.category)),e.difficulty&&(d=d.filter(t=>t.difficulty===e.difficulty)),0===d.length)return console.warn("No guides match the selected filters"),null;const a=d.filter(e=>!t[e.id]?.completed),o=d.filter(e=>t[e.id]?.completed);let n;return n=Math.random()<.8&&a.length>0?a[Math.floor(Math.random()*a.length)]:o.length>0?o[Math.floor(Math.random()*o.length)]:a.length>0?a[Math.floor(Math.random()*a.length)]:d[Math.floor(Math.random()*d.length)],n}function createPreviewCard(e){const t=document.createElement("div");t.className="random-guide-preview-card";const d=storage.getProgress(),a=d[e.id]?.completed;let o="";if(e.icon&&(o+=`<div class="random-guide-icon">${e.icon}</div>`),o+='<div class="random-guide-content">',o+=`<h3 class="random-guide-title">${escapeHtml(e.title)}</h3>`,o+=a?'<span class="random-guide-badge-read" aria-label="Guide already read">Already Read</span>':'<span class="random-guide-badge-unread" aria-label="Unread guide">Unread</span>',e.description&&(o+=`<p class="random-guide-description">${escapeHtml(e.description)}</p>`),o+='<div class="random-guide-meta">',e.difficulty){const t=e.difficulty.charAt(0).toUpperCase()+e.difficulty.slice(1);o+=`<span class="random-guide-difficulty difficulty-${e.difficulty}">${t}</span>`}return e.readingTime&&(o+=`<span class="random-guide-reading-time">~${e.readingTime} min</span>`),o+="</div>",o+="</div>",t.innerHTML=o,t}export function showRandomGuideModal(e={}){const t=getRandomGuide(e);if(!t)return void alert("No guides found matching your criteria");const d=document.createElement("div");d.id="random-guide-modal",d.className="random-guide-modal",d.setAttribute("role","dialog"),d.setAttribute("aria-modal","true"),d.setAttribute("aria-labelledby","random-guide-title");const a=document.createElement("div");a.className="random-guide-modal-content";const o=document.createElement("button");o.className="random-guide-close-btn",o.setAttribute("aria-label","Close random guide modal"),o.textContent="Ã—",o.addEventListener("click",()=>{d.remove(),document.body.style.overflow=""}),a.appendChild(o);const n=createPreviewCard(t);a.appendChild(n);const i=document.createElement("div");i.className="random-guide-buttons";const r=document.createElement("button");r.className="random-guide-btn random-guide-btn-primary",r.textContent="Go to Guide",r.addEventListener("click",()=>{d.remove(),document.body.style.overflow="",window.location.href=t.url||`guides/${t.id}.html`});const l=document.createElement("button");l.className="random-guide-btn random-guide-btn-secondary",l.textContent="Try Another",l.addEventListener("click",()=>{d.remove(),document.body.style.overflow="",showRandomGuideModal(e)}),i.appendChild(r),i.appendChild(l),a.appendChild(i),d.appendChild(a),document.body.appendChild(d),document.body.style.overflow="hidden",r.focus();const s=e=>{"Escape"===e.key&&(d.remove(),document.body.style.overflow="",document.removeEventListener("keydown",s))};document.addEventListener("keydown",s),d.addEventListener("click",e=>{e.target===d&&(d.remove(),document.body.style.overflow="")})}export async function init(){try{allGuidesData=await fetchGuidesData();const e=document.getElementById("random-guide-btn");e&&e.addEventListener("click",()=>{showRandomGuideModal()}),console.log("Random guide module initialized")}catch(e){console.error("Failed to initialize random guide module:",e)}}