import*as storage from"./storage.js";import*as share from"./share.js";import*as recentlyViewed from"./recently-viewed.js";import*as collections from"./collections.js";import*as practiceMode from"./practice-mode.js";import*as notifications from"./notifications.js";import{escapeHtml}from"./utils.js";let _guidesData=null;export function getGuidesData(){return _guidesData}async function fetchGuidesData(){try{const e=await fetch("data/guides.json");if(!e.ok)throw new Error(`Failed to fetch guides: ${e.status}`);return await e.json()}catch(e){throw console.error("Error fetching guides.json:",e),e}}function createCardElement(e,t=[]){const n=document.createElement("a");n.className="card",n.href=e.url||`guides/${e.id}.html`,n.setAttribute("data-guide",e.id),n.setAttribute("tabindex","0");const o=Array.isArray(e.tags)?e.tags:[];n.setAttribute("data-tags",o.join(" ")),e.category&&n.setAttribute("data-category",e.category),e.difficulty&&n.setAttribute("data-difficulty",e.difficulty),e.prerequisites&&e.prerequisites.length>0&&n.setAttribute("data-prerequisites",e.prerequisites.join(","));let i='<span class="read-check" aria-hidden="true">âœ“</span>';if(e.difficulty){const t=e.difficulty.charAt(0).toUpperCase()+e.difficulty.slice(1);i+=`<span class="difficulty-badge difficulty-${e.difficulty}" title="Difficulty: ${t}">${t}</span>`}if(e.icon&&(i+=`<span class="icon">${e.icon}</span>`),e.title&&(i+=`<h3>${escapeHtml(e.title)}</h3>`),e.description&&(i+=`<p>${escapeHtml(e.description)}</p>`),e.readingTime&&(i+=`<span class="reading-time">~${e.readingTime} min read</span>`),o.length>0)for(const e of o)i+=`<span class="tag ${e}">${formatTagText(e)}</span>`;if(e.prerequisites&&e.prerequisites.length>0){const n={};t.forEach(e=>{n[e.id]=e});const o=e.prerequisites.map(e=>{const t=n[e];return t?`${t.icon||"ðŸ“˜"} ${escapeHtml(t.title)}`:e});i+=`<div class="${1===e.prerequisites.length?"prerequisites prerequisites-single":"prerequisites"}"><strong>Prerequisites:</strong> ${o.join(", ")}</div>`}return n.innerHTML=i,share.addShareButtonToCard(n),addCollectionButtonToCard(n,e.id),notifications.addBadgesToCard(n,e,t),n}function formatTagText(e){return{"start-here":"Start Here","new-guide":"New",critical:"Critical",essential:"Essential",important:"Important",practical:"Practical",new:"New",rebuild:"Rebuild",technology:"Technology",human:"Human",medical:"Medical",winter:"Winter"}[e]||e.charAt(0).toUpperCase()+e.slice(1)}function groupByCategory(e){const t={};for(const n of e){const e=n.category||"uncategorized";t[e]||(t[e]=[]),t[e].push(n)}return t}function getCategoryDisplay(e){return{"zth-modules":{name:"Core Modules",icon:"ðŸŽ“"},survival:{name:"Immediate Survival",icon:"ðŸ”¥"},medical:{name:"Medical & Health",icon:"ðŸ¥"},agriculture:{name:"Food & Agriculture",icon:"ðŸŒ¾"},building:{name:"Building & Engineering",icon:"ðŸ”¨"},crafts:{name:"Crafts & Trade Skills",icon:"âš’ï¸"},communications:{name:"Communications",icon:"ðŸ“¡"},defense:{name:"Security & Defense",icon:"ðŸ›¡ï¸"},sciences:{name:"Foundational Sciences",icon:"ðŸ”¬"},chemistry:{name:"Industrial Chemistry",icon:"ðŸ­"},society:{name:"Society & Culture",icon:"ðŸ›ï¸"},tools:{name:"Tools & Interactive",icon:"ðŸ› ï¸"},salvage:{name:"Scavenging & Salvage",icon:"â™»ï¸"},reference:{name:"Master Reference",icon:"ðŸ“š"},specialized:{name:"Specialized",icon:"ðŸ”§"},metalworking:{name:"Metalworking",icon:"âš’ï¸"},"primitive-technology":{name:"Primitive Technology",icon:"ðŸª¨"},"power-generation":{name:"Power Generation",icon:"âš¡"},transportation:{name:"Transportation",icon:"ðŸš—"},"resource-management":{name:"Resource Management",icon:"ðŸ“¦"},"culture-knowledge":{name:"Culture & Knowledge",icon:"ðŸ“–"},biology:{name:"Biology",icon:"ðŸ§¬"},utility:{name:"Utilities",icon:"âš™ï¸"}}[e]||{name:e,icon:"ðŸ“„"}}function createSectionHeading(e){const{name:t,icon:n}=getCategoryDisplay(e),o=document.createElement("h2");return o.className="section-heading",o.id=`sec-${e}`,o.textContent=`${n} ${t}`,o}const ESTIMATED_CARD_ROW_HEIGHT=220,CARDS_PER_ROW=3;let _sectionObserver=null,_groupedGuides=null;function renderGuides(e){const t=document.getElementById("guides-container");if(!t)return void console.error("guides-container element not found");_sectionObserver&&_sectionObserver.disconnect(),t.innerHTML="";const n=notifications.createWhatsNewSection(e);n&&t.appendChild(n);const o=groupByCategory(e);_groupedGuides=o;const i=["zth-modules","survival","medical","agriculture","building","crafts","metalworking","communications","defense","sciences","chemistry","power-generation","transportation","society","resource-management","salvage","tools","reference","specialized"],r=[...i.filter(e=>e in o),...Object.keys(o).filter(e=>!i.includes(e)).sort()];_sectionObserver=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){const n=t.target;if(!n.dataset.rendered){const t=n.dataset.category,i=o[t];i&&(renderSectionCards(n,i,e),applyCurrentFilterToSection(n)),n.dataset.rendered="true",n.style.minHeight="",_sectionObserver.unobserve(n)}}})},{rootMargin:"300px 0px"});let a=0;for(const n of r){if(""===n||"uncategorized"===n)continue;const i=o[n],r=createSectionHeading(n);t.appendChild(r);const c=document.createElement("div");if(c.className="card-section",c.dataset.category=n,c.setAttribute("data-section",n),a<3)renderSectionCards(c,i,e),c.dataset.rendered="true";else{const e=Math.ceil(i.length/3);c.style.minHeight=220*e+"px",_sectionObserver.observe(c)}t.appendChild(c),a++}if(o[""]&&o[""].length>0){const n=document.createElement("h2");n.className="section-heading",n.textContent="ðŸ“„ Other Guides",t.appendChild(n);const i=document.createElement("div");i.className="card-section",i.dataset.category="uncategorized",i.setAttribute("data-section","uncategorized"),renderSectionCards(i,o[""],e),i.dataset.rendered="true",t.appendChild(i)}}function renderSectionCards(e,t,n){const o=document.createDocumentFragment();for(const e of t){const t=createCardElement(e,n);o.appendChild(t)}e.appendChild(o)}function applyCurrentFilterToSection(e){const t=document.querySelector(".filter-btn.active"),n=t?t.getAttribute("data-filter"):"all";if("all"===n)return;const o=storage.getProgress();e.querySelectorAll(".card[data-guide]").forEach(e=>{const t=e.getAttribute("data-tags")||"",i=e.getAttribute("data-guide"),r=e.getAttribute("data-category")||"",a=e.getAttribute("data-difficulty")||"",c=o[i]?.completed;let s=!0;"critical"===n?s=t.includes("critical"):"essential"===n?s=t.includes("essential"):"rebuild"===n?s=t.includes("rebuild"):"new"===n?s=t.includes("new"):"unread"===n?s=!c:"completed"===n?s=c:"beginner"===n?s="beginner"===a:"intermediate"===n?s="intermediate"===a:"advanced"===n?s="advanced"===a:"tools"===n&&(s="tools"===r),e.style.display=s?"":"none"})}function showLoadingState(){const e=document.getElementById("guides-container");e&&(e.innerHTML='<div class="loading-state">Loading guides...</div>')}function showErrorState(e){const t=document.getElementById("guides-container");t&&(t.innerHTML=`<div class="error-state"><p>Error loading guides: ${escapeHtml(e)}</p><p>Please refresh the page to try again.</p></div>`)}export function forceRenderSection(e){const t=document.querySelector(`[data-section="${e}"]`);return!!t&&("true"===t.dataset.rendered||!!(_groupedGuides&&_groupedGuides[e]&&_guidesData)&&(renderSectionCards(t,_groupedGuides[e],_guidesData),applyCurrentFilterToSection(t),t.dataset.rendered="true",t.style.minHeight="",_sectionObserver&&_sectionObserver.unobserve(t),!0))}export async function initializeCards(){try{showLoadingState();const e=await fetchGuidesData();_guidesData=e,renderGuides(e),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{share.initShareButtons(),window.dispatchEvent(new CustomEvent("cardsRendered"))}):(share.initShareButtons(),window.dispatchEvent(new CustomEvent("cardsRendered")))}catch(e){console.error("Failed to initialize cards:",e),showErrorState(e.message||"Unknown error")}}export function getCards(){return document.querySelectorAll(".card[data-guide]")}export async function rerenderCards(e){try{e||(e=await fetchGuidesData()),renderGuides(e),share.initShareButtons(),window.dispatchEvent(new CustomEvent("cardsRerendered"))}catch(e){console.error("Failed to rerender cards:",e),showErrorState(e.message||"Unknown error")}}function addCollectionButtonToCard(e,t){const n=document.createElement("button");n.className="add-to-collection-btn",n.title="Add to collection",n.textContent="ðŸ“Œ",n.type="button",n.setAttribute("aria-label","Add to collection"),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),showCollectionDropdown(n,t)}),e.appendChild(n)}function showCollectionDropdown(e,t){document.querySelectorAll(".collection-dropdown").forEach(e=>e.remove());const n=document.createElement("div");n.className="collection-dropdown";const o=collections.getCollectionsSorted();if(0===o.length){const e=document.createElement("div");e.className="collection-empty",e.textContent="No collections yet. Create one below.",n.appendChild(e)}else o.forEach(e=>{const o=document.createElement("div");o.className="collection-item";const i=document.createElement("input");i.type="checkbox",i.id=`col-${e.id}`,i.checked=collections.isGuideInCollection(e.id,t),i.addEventListener("change",()=>{i.checked?collections.addToCollection(e.id,t):collections.removeFromCollection(e.id,t),updateCollectionCounts()});const r=document.createElement("label");r.htmlFor=`col-${e.id}`;const a=collections.getCollectionProgress(e.id);r.innerHTML=`<span class="col-icon">${e.icon}</span> <span class="col-name">${escapeHtml(e.name)}</span> <span class="col-count">${a.read}/${a.total}</span>`,o.appendChild(i),o.appendChild(r),n.appendChild(o)});const i=document.createElement("div");i.className="collection-create-section";const r=document.createElement("button");r.className="create-collection-btn",r.textContent="+ New Collection",r.type="button",r.addEventListener("click",()=>{const n=prompt("Collection name:");if(n&&n.trim()){const o=collections.createCollection(n.trim());collections.addToCollection(o.id,t),showCollectionDropdown(e,t),updateCollectionCounts(),window.dispatchEvent(new CustomEvent("collectionsUpdated"))}}),i.appendChild(r),n.appendChild(i);const a=e.getBoundingClientRect();n.style.top=a.bottom+5+"px",n.style.left=a.left-10+"px",document.body.appendChild(n),setTimeout(()=>{const t=o=>{n.contains(o.target)||o.target===e||(n.remove(),document.removeEventListener("click",t))};document.addEventListener("click",t)},0)}function updateCollectionCounts(){document.querySelectorAll(".col-count").forEach(e=>{const t=e.parentElement.previousElementSibling;if(t&&t.id){const n=t.id.replace("col-",""),o=collections.getCollectionProgress(n);e.textContent=`${o.read}/${o.total}`}})}