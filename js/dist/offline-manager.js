const OFFLINE_CACHE_PREFIX="offline-category-",OFFLINE_CACHE_VERSION="v1",CATEGORY_METADATA_KEY="offline-manager-categories";let categoryData={},categoryCacheStatus={},guidesData=[];export async function init(){try{const e=await fetch("./data/guides.json");guidesData=await e.json(),buildCategoryMetadata(),await loadCacheStatus(),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("message",handleServiceWorkerMessage)}catch(e){console.error("Failed to initialize offline manager:",e)}}function buildCategoryMetadata(){const e={};guidesData.forEach(t=>{e[t.category]||(e[t.category]={name:formatCategoryName(t.category),guides:[],totalSize:0}),e[t.category].guides.push(t),e[t.category].totalSize+=5e3}),categoryData=e}function formatCategoryName(e){return e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}async function loadCacheStatus(){try{const e=(await caches.keys()).filter(e=>e.startsWith("offline-category-"));for(const t of e){const e=t.replace("offline-category-v1-","");categoryCacheStatus[e]={cached:!0,itemCount:0,cacheSize:0};const a=await caches.open(t),c=await a.keys();categoryCacheStatus[e].itemCount=c.length;for(const t of c){const c=await a.match(t);if(c){const t=await c.blob();categoryCacheStatus[e].cacheSize+=t.size}}}}catch(e){console.error("Failed to load cache status:",e)}}export async function cacheCategory(e){try{if(!categoryData[e])return console.warn(`Category not found: ${e}`),!1;const t=categoryData[e].guides,a=`offline-category-v1-${e}`,c=await caches.open(a);let o=0;const r=t.length;dispatchProgressUpdate(e,0,r);for(let a=0;a<t.length;a++){try{const e=`./${t[a].file}`,r=await fetch(e);r.ok&&(await c.put(e,r.clone()),o++)}catch(e){console.error(`Failed to cache guide ${t[a].id}:`,e)}dispatchProgressUpdate(e,a+1,r)}return categoryCacheStatus[e]={cached:!0,itemCount:o,cacheSize:categoryData[e].totalSize},!0}catch(t){return console.error(`Failed to cache category ${e}:`,t),!1}}export async function uncacheCategory(e){try{const t=`offline-category-v1-${e}`,a=await caches.delete(t);return a&&(categoryCacheStatus[e]={cached:!1,itemCount:0,cacheSize:0}),a}catch(t){return console.error(`Failed to uncache category ${e}:`,t),!1}}export async function getCachedGuides(){const e={};try{const t={};for(const e of guidesData)e.file&&(t[e.file.replace(/^\.\//,"")]=e.id);const a=(await caches.keys()).filter(e=>e.startsWith("offline-category-"));for(const c of a){const a=await caches.open(c),o=await a.keys();for(const a of o){const c=a.url;for(const[a,o]of Object.entries(t))if(c.endsWith(a)){e[o]=!0;break}}}}catch(e){console.error("Failed to get cached guides:",e)}return e}export async function cacheAll(){const e=Object.keys(categoryData);for(const t of e)await cacheCategory(t)}export async function clearAll(){try{const e=(await caches.keys()).filter(e=>e.startsWith("offline-category-"));for(const t of e)await caches.delete(t);return Object.keys(categoryCacheStatus).forEach(e=>{categoryCacheStatus[e]={cached:!1,itemCount:0,cacheSize:0}}),!0}catch(e){return console.error("Failed to clear all caches:",e),!1}}export function getTotalStorageUsed(){return Object.values(categoryCacheStatus).reduce((e,t)=>e+t.cacheSize,0)}export function getCategoryList(){return Object.keys(categoryData).map(e=>({id:e,name:categoryData[e].name,guideCount:categoryData[e].guides.length,estimatedSize:categoryData[e].totalSize,isCached:categoryCacheStatus[e]?.cached||!1,cachedSize:categoryCacheStatus[e]?.cacheSize||0,cachedCount:categoryCacheStatus[e]?.itemCount||0}))}function dispatchProgressUpdate(e,t,a){const c=new CustomEvent("offline-manager:progress",{detail:{category:e,current:t,total:a,percentage:Math.round(t/a*100)}});document.dispatchEvent(c)}function handleServiceWorkerMessage(e){e.data&&"CACHE_EVENT"===e.data.type&&console.log("Cache event:",e.data)}export function formatBytes(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]}