import*as storage from"./storage.js";const categoryColors={"zth-modules":"#d4a574",survival:"#ff6b6b",medical:"#ff9999",agriculture:"#53d8a8",building:"#8b7355",crafts:"#b19cd9",communications:"#4a9eff",defense:"#ff8c42",sciences:"#7ec8e3",chemistry:"#ffd700",society:"#a78bfa",tools:"#6ee7b7",salvage:"#9ca3af",reference:"#d4a574",specialized:"#b19cd9",metalworking:"#c084fc","primitive-technology":"#92400e","power-generation":"#fbbf24",transportation:"#60a5fa","resource-management":"#a78bfa","culture-knowledge":"#d4a574",biology:"#86efac",utility:"#cbd5e1"},milestoneMessages={25:"ðŸŒ± Growing strong!",50:"âš¡ Halfway there!",75:"ðŸŽ¯ Almost mastered!",100:"ðŸ† Category complete!"};async function fetchGuidesData(){try{const e=await fetch("data/guides.json");if(!e.ok)throw new Error(`Failed to fetch guides: ${e.status}`);return await e.json()}catch(e){throw console.error("Error fetching guides.json:",e),e}}function calculateCategoryStats(e,t){const r={};for(const o of e){const e=o.category||"uncategorized";r[e]||(r[e]={name:getCategoryName(e),icon:getCategoryIcon(e),total:0,read:0,percentage:0}),r[e].total++,t[o.id]?.completed&&r[e].read++}for(const e in r){const t=r[e];t.percentage=t.total>0?Math.round(t.read/t.total*100):0}return r}function getCategoryName(e){return{"zth-modules":"Core Modules",survival:"Immediate Survival",medical:"Medical & Health",agriculture:"Food & Agriculture",building:"Building & Engineering",crafts:"Crafts & Trade Skills",communications:"Communications",defense:"Security & Defense",sciences:"Foundational Sciences",chemistry:"Industrial Chemistry",society:"Society & Culture",tools:"Tools & Interactive",salvage:"Scavenging & Salvage",reference:"Master Reference",specialized:"Specialized",metalworking:"Metalworking","primitive-technology":"Primitive Technology","power-generation":"Power Generation",transportation:"Transportation","resource-management":"Resource Management","culture-knowledge":"Culture & Knowledge",biology:"Biology",utility:"Utilities"}[e]||e}function getCategoryIcon(e){return{"zth-modules":"ðŸŽ“",survival:"ðŸ”¥",medical:"ðŸ¥",agriculture:"ðŸŒ¾",building:"ðŸ”¨",crafts:"âš’ï¸",communications:"ðŸ“¡",defense:"ðŸ›¡ï¸",sciences:"ðŸ”¬",chemistry:"ðŸ­",society:"ðŸ›ï¸",tools:"ðŸ› ï¸",salvage:"â™»ï¸",reference:"ðŸ“š",specialized:"ðŸ”§",metalworking:"âš’ï¸","primitive-technology":"ðŸª¨","power-generation":"âš¡",transportation:"ðŸš—","resource-management":"ðŸ“¦","culture-knowledge":"ðŸ“–",biology:"ðŸ§¬",utility:"âš™ï¸"}[e]||"ðŸ“„"}function getMilestoneMessage(e){for(const t of[100,75,50,25])if(e>=t)return milestoneMessages[t];return""}function createProgressItem(e,t){const r=document.createElement("div");r.className="progress-item",r.setAttribute("data-category",e);const o=categoryColors[e]||"#d4a574",a=getMilestoneMessage(t.percentage);return r.innerHTML=`\n    <div class="progress-header">\n      <span class="progress-category-name">\n        <span class="progress-icon">${t.icon}</span>\n        ${t.name}\n      </span>\n      <span class="progress-count">${t.read}/${t.total}</span>\n    </div>\n    <div class="progress-bar-container">\n      <div class="progress-bar">\n        <div class="progress-fill" style="width: ${t.percentage}%; background-color: ${o};"></div>\n      </div>\n      <div class="progress-text">${t.percentage}%</div>\n    </div>\n    ${a?`<div class="progress-milestone">${a}</div>`:""}\n  `,r}async function renderProgressVisualization(){try{const e=calculateCategoryStats(await fetchGuidesData(),storage.getProgress());let t=document.getElementById("category-progress");if(!t){t=document.createElement("section"),t.id="category-progress",t.className="category-progress";const e=document.getElementById("guides-container");e?e.parentNode.insertBefore(t,e):document.body.appendChild(t)}t.innerHTML="";const r=document.createElement("h2");r.className="progress-section-title",r.textContent="ðŸ“ˆ Your Progress",t.appendChild(r);const o=["zth-modules","survival","medical","agriculture","building","crafts","communications","defense","sciences","chemistry","society","metalworking","power-generation","transportation","resource-management","tools","salvage","reference","specialized"],a=[...o.filter(t=>t in e),...Object.keys(e).filter(e=>!o.includes(e)&&"uncategorized"!==e).sort()];for(const r of a){const o=createProgressItem(r,e[r]);t.appendChild(o)}}catch(e){console.error("Error rendering progress visualization:",e)}}export async function updateProgressVisualization(){await renderProgressVisualization()}export async function init(){try{await renderProgressVisualization(),window.addEventListener("storage",async e=>{"compendium-progress"===e.key&&await updateProgressVisualization()}),window.addEventListener("progressUpdated",async()=>{await updateProgressVisualization()})}catch(e){console.error("Failed to initialize progress visualization:",e)}}