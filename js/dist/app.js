import*as errorTracking from"./error-tracking.js";import*as errorViewer from"./error-viewer.js";errorTracking.init(),errorViewer.init();import*as config from"./config.js";import*as storage from"./storage.js";import*as ui from"./ui.js";import*as keyboard from"./keyboard.js";import*as cards from"./cards.js";import*as offlineIndicator from"./offline-indicator.js";import*as pwa from"./pwa.js";import*as toc from"./toc.js";async function initializeApp(){config.initialize(),config.debug("Application initialization started",{environment:config.getEnvironment()});try{pwa.init()}catch(e){config.log("error","Failed to initialize PWA features:",e)}offlineIndicator.init();try{await cards.initializeCards()}catch(e){config.log("error","Failed to initialize cards:",e)}const e=document.querySelectorAll(".card[data-guide]");ui.initializeThemeToggle(),ui.updateProgressDisplay(e),ui.initializeFilters(),ui.initializeBackToTop(),toc.initializeTOC(),keyboard.initializeKeyboardShortcuts(()=>{ensureSearchLoaded().then(e=>e?.focusSearch())}),setupLazySearch(),registerServiceWorker(),loadDeferredModules(e)}let _searchModule=null,_searchLoading=!1;async function ensureSearchLoaded(){if(_searchModule)return _searchModule;if(_searchLoading)return new Promise(e=>{const i=setInterval(()=>{_searchModule&&(clearInterval(i),e(_searchModule))},10)});_searchLoading=!0;try{_searchModule=await import("./search.js");const e=cards.getGuidesData();if(e){_searchModule.initializeSearch(e);const i=document.getElementById("search")||document.getElementById("quick-search-input");i&&i.value.length>0&&i.dispatchEvent(new Event("input",{bubbles:!0}))}}catch(e){config.log("error","Failed to load search module:",e)}return _searchLoading=!1,_searchModule}function setupLazySearch(){const e=document.getElementById("search")||document.getElementById("quick-search-input");e&&(e.addEventListener("focus",()=>{ensureSearchLoaded()},{once:!0}),e.addEventListener("mouseenter",()=>{ensureSearchLoaded()},{once:!0}))}async function loadDeferredModules(e){try{const[i,o,t,r,n,a,s,d,c,l,g,p,f,u]=await Promise.all([import("./analytics.js"),import("./text-sizing.js"),import("./achievements.js"),import("./import-export.js"),import("./recently-viewed.js"),import("./progress-viz.js"),import("./collections-ui.js"),import("./random-guide.js"),import("./tools-nav.js"),import("./learning-paths.js"),import("./practice-mode.js"),import("./notifications.js"),import("./offline-manager.js"),import("./offline-manager-ui.js")]);try{i.init()}catch(e){config.log("error","Failed to initialize analytics:",e)}o.init();try{await p.init()}catch(e){config.log("error","Failed to initialize notifications:",e)}try{await l.init()}catch(e){config.log("error","Failed to initialize learning paths:",e)}try{await a.init()}catch(e){config.log("error","Failed to initialize progress visualization:",e)}n.init(),g.init();try{s.init()}catch(e){config.log("error","Failed to initialize collections UI:",e)}try{await d.init()}catch(e){config.log("error","Failed to initialize random guide module:",e)}c.init(),t.checkAchievements(e),window.showAchievementsModal=t.showAchievementsModal,window.closeAchievementsModal=t.closeAchievementsModal,r.initializeImportHandler(),window.exportProgress=r.exportProgress,window.importProgress=r.importProgress,window.resetProgress=r.resetProgress,window.showExportModal=r.showExportModal,window.closeExportModal=r.closeExportModal,window.exportAsJSON=r.exportAsJSON,window.exportNotesAsCSV=r.exportNotesAsCSV,window.exportProgressAsCSV=r.exportProgressAsCSV,window.exportNotesAsMarkdown=r.exportNotesAsMarkdown,window.restoreFromIndexedDB=r.restoreFromIndexedDB,window.closeRestoreModal=r.closeRestoreModal;try{await r.checkAndOfferIndexedDBRestore()}catch(e){config.log("error","Failed to check for IndexedDB restore:",e)}r.checkBackupReminder();try{await f.init(),u.initUI(),window.offlineManagerUI=u}catch(e){config.log("error","Failed to initialize offline manager:",e)}window.addEventListener("load",()=>{setTimeout(async()=>{try{await u.updateGuideOfflineBadges(),keyboard.initializeCardKeyboardNav()}catch(e){config.log("error","Failed to update offline badges:",e)}},100)}),config.debug("Deferred modules loaded successfully")}catch(e){config.log("error","Failed to load deferred modules:",e)}}function registerServiceWorker(){config.shouldUseServiceWorker()?"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js").then(e=>{if(config.log("debug","Service Worker registered:",{scope:e.scope}),e.installing){const i=e.installing;i.addEventListener("statechange",()=>{if("installed"===i.state)if(navigator.serviceWorker.controller){const e=document.createElement("div");e.id="sw-update-banner",e.style.cssText="position:fixed;bottom:0;left:0;right:0;background:#4a9eff;color:#fff;padding:12px;text-align:center;font-size:0.9rem;z-index:9999",e.innerHTML="<span>App update available. </span>";const i=document.createElement("button");i.textContent="Reload",i.style.cssText="background:white;color:#4a9eff;border:none;padding:4px 12px;border-radius:3px;cursor:pointer;font-weight:bold;",i.addEventListener("click",()=>window.location.reload()),e.appendChild(i),document.body.appendChild(e)}else{const e=document.createElement("div");e.id="sw-ready-banner",e.style.cssText="position:fixed;bottom:0;left:0;right:0;background:#44a854;color:#fff;padding:12px;text-align:center;font-size:0.9rem;z-index:9999",e.textContent="Ready for offline use",document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 0.5s",setTimeout(()=>e.remove(),500)},3e3)}else"activated"===i.state&&console.log("SW activated and ready")})}e.addEventListener("updatefound",()=>{const i=e.installing;i.addEventListener("statechange",()=>{"activated"===i.state&&config.debug("Service Worker updated and activated")})})}).catch(e=>{config.log("error","Service Worker registration failed:",e);const i=document.createElement("div");i.id="sw-error-banner",i.style.cssText="position:fixed;bottom:0;left:0;right:0;background:#c94444;color:#fff;padding:12px;text-align:center;font-size:0.9rem;z-index:9999",i.textContent="Offline mode unavailable. Please reload the page.",document.body.appendChild(i)}):config.debug("Service Worker registration skipped",{reason:"Disabled in config"})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeApp):initializeApp();