const DISMISS_BANNER_KEY="pwa-install-banner-dismissed",DISMISS_DURATION=6048e5,SW_UPDATE_CHECK_INTERVAL=864e5;let deferredPrompt=null,updateAvailable=!1;export function init(){handleBeforeInstallPrompt(),handleServiceWorkerUpdates(),handleAppInstalled()}function handleBeforeInstallPrompt(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e,showInstallBanner()})}function showInstallBanner(){const e=localStorage.getItem(DISMISS_BANNER_KEY);if(e&&Date.now()-parseInt(e,10)<6048e5)return;const t=document.createElement("div");t.className="pwa-install-banner",t.setAttribute("role","region"),t.setAttribute("aria-label","Install app banner"),t.innerHTML='\n    <div class="pwa-banner-content">\n      <div class="pwa-banner-icon">\n        <img src="assets/icon-192.png" alt="App icon" width="48" height="48" />\n      </div>\n      <div class="pwa-banner-info">\n        <h3 class="pwa-banner-title">Install Survival Compendium</h3>\n        <p class="pwa-banner-description">Quick access to 220+ offline survival guides without opening your browser</p>\n      </div>\n      <div class="pwa-banner-actions">\n        <button class="pwa-install-btn" aria-label="Install app">Install</button>\n        <button class="pwa-dismiss-btn" aria-label="Dismiss install prompt">Dismiss</button>\n      </div>\n    </div>\n  ',document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("visible")}),t.querySelector(".pwa-install-btn").addEventListener("click",async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();const{outcome:e}=await deferredPrompt.userChoice;"accepted"===e?console.log("User accepted install prompt"):console.log("User dismissed install prompt"),deferredPrompt=null,t.classList.remove("visible"),setTimeout(()=>t.remove(),300)}),t.querySelector(".pwa-dismiss-btn").addEventListener("click",()=>{localStorage.setItem(DISMISS_BANNER_KEY,Date.now().toString()),t.classList.remove("visible"),setTimeout(()=>t.remove(),300)})}function handleServiceWorkerUpdates(){"serviceWorker"in navigator&&(navigator.serviceWorker.addEventListener("controllerchange",()=>{updateAvailable&&showUpdateBanner()}),setInterval(()=>{checkForServiceWorkerUpdate()},864e5),checkForServiceWorkerUpdate())}async function checkForServiceWorkerUpdate(){if(navigator.serviceWorker.controller)try{const e=await navigator.serviceWorker.getRegistration();if(!e)return;await e.update(),e.waiting&&(updateAvailable=!0,showUpdateBanner())}catch(e){console.error("Error checking for SW updates:",e)}}function showUpdateBanner(){if(document.querySelector(".pwa-update-banner"))return;const e=document.createElement("div");e.className="pwa-update-banner",e.setAttribute("role","region"),e.setAttribute("aria-label","App update available"),e.innerHTML='\n    <div class="pwa-banner-content">\n      <div class="pwa-banner-icon update-icon">⬆️</div>\n      <div class="pwa-banner-info">\n        <h3 class="pwa-banner-title">Update Available</h3>\n        <p class="pwa-banner-description">New guides and features are ready. Refresh to get the latest version.</p>\n      </div>\n      <div class="pwa-banner-actions">\n        <button class="pwa-update-btn" aria-label="Update app">Update Now</button>\n        <button class="pwa-dismiss-btn" aria-label="Dismiss update prompt">Later</button>\n      </div>\n    </div>\n  ',document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")}),e.querySelector(".pwa-update-btn").addEventListener("click",async()=>{try{const e=await navigator.serviceWorker.getRegistration();e&&e.waiting&&e.waiting.postMessage({type:"SKIP_WAITING"})}catch(e){console.error("Error activating waiting SW:",e)}setTimeout(()=>{window.location.reload()},500)}),e.querySelector(".pwa-dismiss-btn").addEventListener("click",()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300)});const t=setTimeout(()=>{document.body.contains(e)&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),300))},8e3);e.addEventListener("click",()=>{clearTimeout(t)})}function handleAppInstalled(){window.addEventListener("appinstalled",()=>{console.log("App successfully installed"),deferredPrompt=null;const e=document.querySelector(".pwa-install-banner");e&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),300)),localStorage.removeItem(DISMISS_BANNER_KEY),showInstallSuccessToast()})}function showInstallSuccessToast(){const e=document.createElement("div");e.className="pwa-install-toast",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.textContent="Survival Compendium installed! Quick access from your home screen.",document.body.appendChild(e),setTimeout(()=>{e.classList.add("hide"),setTimeout(()=>e.remove(),300)},4e3)}export async function checkForUpdates(){if(!navigator.serviceWorker.controller)return console.log("No active service worker"),!1;try{const e=await navigator.serviceWorker.getRegistration();return!!e&&(await e.update(),null!==e.waiting)}catch(e){return console.error("Error checking for updates:",e),!1}}export async function canPromptForInstall(){return null!==deferredPrompt}export async function promptInstall(){if(!deferredPrompt)return console.log("Install prompt not available"),!1;deferredPrompt.prompt();const{outcome:e}=await deferredPrompt.userChoice;return deferredPrompt=null,"accepted"===e}